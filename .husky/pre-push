#!/usr/bin/env sh

echo "ğŸš€ Running pre-push build verification..."

# âœ… ENTERPRISE: Get branch info with error handling
branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
if [ -z "$branch" ]; then
    echo "âŒ Could not determine current branch"
    exit 1
fi

# âœ… ENTERPRISE: Check for commits to push
unpushed_commits=$(git log @{u}..HEAD --oneline 2>/dev/null | wc -l)
if [ "$unpushed_commits" -eq 0 ]; then
    echo "â„¹ï¸  No new commits to push, skipping pre-push checks"
    exit 0
fi

echo "ğŸ“‹ Branch: $branch"
echo "ğŸ“Š Commits to push: $unpushed_commits"

# âœ… ENTERPRISE: Performance timing
start_time=$(date +%s)

# âœ… ENTERPRISE: Branch-specific quality gates
if [[ "$branch" == "main" || "$branch" == "develop" ]]; then
    echo "ğŸ”’ Critical branch detected ($branch) - running comprehensive validation"
    echo "â³ This may take 5-10 minutes for full E2E and security checks..."
    
    bun run qa:full
    qa_exit_code=$?
    
    if [ $qa_exit_code -eq 0 ]; then
        echo "âœ… Full validation passed for critical branch"
    else
        echo "âŒ Full validation failed for critical branch"
        echo "ğŸš« Push to $branch requires all tests to pass"
        exit 1
    fi
    
elif [[ "$branch" == hotfix/* ]]; then
    echo "ğŸš¨ Hotfix branch detected ($branch) - running essential checks only"
    
    bun run qa:build
    qa_exit_code=$?
    
    if [ $qa_exit_code -eq 0 ]; then
        echo "âœ… Essential checks passed for hotfix"
        echo "âš ï¸  Remember to run full validation after hotfix deployment"
    else
        echo "âŒ Essential checks failed for hotfix"
        exit 1
    fi
    
else
    echo "ğŸ“¦ Feature branch ($branch) - running build verification"
    
    bun run qa:build
    qa_exit_code=$?
    
    if [ $qa_exit_code -eq 0 ]; then
        echo "âœ… Build verification passed for feature branch"
    else
        echo "âŒ Build verification failed"
        echo "ğŸ”§ Run 'bun run qa:fix' to resolve common issues"
        exit 1
    fi
fi

# âœ… ENTERPRISE: Performance reporting
end_time=$(date +%s)
duration=$((end_time - start_time))
duration_min=$((duration / 60))
duration_sec=$((duration % 60))

echo "â±ï¸  Pre-push validation completed in ${duration_min}m ${duration_sec}s"

# âœ… ENTERPRISE: Performance recommendations
if [[ "$branch" == "main" || "$branch" == "develop" ]] && [ $duration -gt 600 ]; then
    echo "âš ï¸  Warning: Full validation took longer than 10 minutes"
    echo "ğŸ’¡ Consider optimizing E2E tests or running them in parallel"
fi

echo "ğŸ‰ Pre-push hook completed successfully!"
echo "ğŸš€ Ready to push $unpushed_commits commit(s) to $branch"
