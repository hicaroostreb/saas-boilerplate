#!/usr/bin/env sh

echo "ğŸ” Running pre-commit quality checks..."

# âœ… ENTERPRISE: Check if there are staged files to avoid empty commits
staged_files=$(git diff --cached --name-only)
if [ -z "$staged_files" ]; then
    echo "âš ï¸  No staged files found. Please stage your changes before committing."
    exit 1
fi

# âœ… ENTERPRISE: Use lint-staged for staged files only (performance)
echo "ğŸ“ Running lint-staged on changed files..."
bunx lint-staged

# âœ… ENTERPRISE: Only run qa:fast if lint-staged passes (fail-fast pattern)
if [ $? -eq 0 ]; then
    echo "âœ… Lint-staged passed, running final quality check..."
    
    # âœ… ENTERPRISE: Add timing for performance monitoring
    start_time=$(date +%s)
    bun run qa:fast
    qa_exit_code=$?
    end_time=$(date +%s)
    duration=$((end_time - start_time))
    
    if [ $qa_exit_code -eq 0 ]; then
        echo "âœ… Pre-commit checks completed successfully in ${duration}s"
        
        # âœ… ENTERPRISE: Performance warning if too slow
        if [ $duration -gt 30 ]; then
            echo "âš ï¸  Warning: qa:fast took ${duration}s (target: <30s)"
            echo "ğŸ’¡ Consider optimizing the qa:fast pipeline"
        fi
    else
        echo "âŒ Quality checks failed after ${duration}s"
        echo "ğŸ”§ Run 'bun run qa:fix' to automatically fix common issues"
        exit 1
    fi
else
    echo "âŒ Lint-staged failed, please fix issues before committing"
    echo "ğŸ”§ Run 'bun run qa:fix' to automatically fix formatting and linting issues"
    exit 1
fi

echo "ğŸ‰ Pre-commit hook completed successfully!"